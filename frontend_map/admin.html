<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - WebGIS</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <style>
        body { background-color: #f8f9fa; }
        .stat-card { border-left: 5px solid; }
        .border-primary { border-color: #0d6efd !important; }
        .border-success { border-color: #198754 !important; }
        .border-warning { border-color: #ffc107 !important; }
        .border-danger { border-color: #dc3545 !important; }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
        <script src="https://js.arcgis.com/4.29/"></script>

        <script>
        // L·ªánh gi√∫p c√°c th∆∞ vi·ªán ch·∫°y ƒë·ªôc l·∫≠p, kh√¥ng g√¢y xung ƒë·ªôt.
        if (window.define && window.define.amd) {
            window.define.amd = null;
        }
        </script>

        <style>
            #adminViewDiv { width: 100%; height: 500px; border-radius: 8px; border: 1px solid #ccc; }
        </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark px-4 mb-4">
        <span class="navbar-brand mb-0 h1">üõ°Ô∏è Admin Control Panel</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </nav>

    <div class="container-fluid px-4">
        
        <div class="row mb-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">üó∫Ô∏è M√¥ h√¨nh Qu·∫£n l√Ω 3D</h5>
                    <div>
                        <span class="badge bg-danger">üî¥ C√≥ s·ª± c·ªë</span>
                        <span class="badge bg-success">üü¢ ·ªîn ƒë·ªãnh</span>
                        <span class="badge bg-secondary">‚ö™ C√≤n tr·ªëng</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="adminViewDiv"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-primary shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">T·ªïng CƒÉn H·ªô</h6>
                        <h3 id="statTotal">...</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-success shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">CƒÉn H·ªô Tr·ªëng</h6>
                        <h3 id="statEmpty">...</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-danger shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Y√™u C·∫ßu M·ªõi</h6>
                        <h3 id="statReq" class="text-danger fw-bold">...</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-warning shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Xe Ch·ªù Duy·ªát</h6>
                        <h3 id="statVeh" class="text-warning fw-bold">...</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <span class="fw-bold">üìã Danh s√°ch Y√™u C·∫ßu / B√°o S·ª± C·ªë</span>
    
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggleHistory" onchange="loadRequests()">
                            <label class="form-check-label small" for="toggleHistory">Hi·ªán l·ªãch s·ª≠ (ƒê√£ xong/H·ªßy)</label>
                         </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>CƒÉn h·ªô</th>
                                    <th>N·ªôi dung</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="requestTable">
                                <tr><td colspan="4" class="text-center">ƒêang t·∫£i...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-bold text-danger">üöß Duy·ªát ƒêƒÉng K√Ω Xe</div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="vehicleList">
                            <li class="list-group-item text-center">ƒêang t·∫£i...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm border-warning">
                    <div class="card-header bg-warning bg-opacity-25 fw-bold text-dark">
                        üíé Kh√°ch h√†ng ti·ªÅm nƒÉng (ƒêƒÉng k√Ω thu√™)
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th>Th·ªùi gian</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>Li√™n h·ªá</th>
                                    <th>CƒÉn h·ªô</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="consultTable">
                                <tr><td colspan="5" class="text-center">ƒêang t·∫£i...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4 mb-5">
            <div class="col-12">
                <div class="card shadow-sm border-success">
                    <div class="card-header bg-success bg-opacity-25 fw-bold text-dark d-flex justify-content-between align-items-center">
                        <span>üë• Danh s√°ch C∆∞ D√¢n (ƒêang c∆∞ tr√∫)</span>
                        
                        <div class="d-flex gap-2">
                            <input type="text" id="searchResInput" class="form-control form-control-sm" 
                                   placeholder="üîç T√¨m t√™n, SƒêT, cƒÉn h·ªô..." 
                                   onkeyup="searchResident()" 
                                   style="width: 250px;">
                                   
                            <button class="btn btn-sm btn-outline-dark" onclick="loadResidents()">üîÑ L√†m m·ªõi</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>CƒÉn h·ªô</th>
                                    <th>H·ªç t√™n</th>
                                    <th>Li√™n h·ªá</th>
                                    <th>Ng√†y v√†o ·ªü</th>
                                    <th>T√†i kho·∫£n</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="residentTable">
                                <tr><td colspan="6" class="text-center">ƒêang t·∫£i...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="contractModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">‚úçÔ∏è T·∫°o H·ª£p ƒê·ªìng & T√†i Kho·∫£n</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="con_consul_id">
                        <input type="hidden" id="con_apt_id">
                        
                        <div class="alert alert-info small">
                            H·ªá th·ªëng s·∫Ω t·∫°o t√†i kho·∫£n c∆∞ d√¢n v√† ƒë·ªïi tr·∫°ng th√°i cƒÉn h·ªô <b id="con_apt_code">...</b> sang "ƒê√£ thu√™".
                        </div>

                        <div class="mb-2"><label>H·ªç t√™n:</label><input type="text" id="con_name" class="form-control" readonly></div>
                        <div class="mb-2"><label>Username:</label><input type="text" id="con_username" class="form-control"></div>
                        <div class="mb-2"><label>Password:</label><input type="text" id="con_password" class="form-control" value="123456"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="button" class="btn btn-primary fw-bold" onclick="submitContract()">‚úÖ K√ù H·ª¢P ƒê·ªíNG</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
    loadConsultations();

        // Check quy·ªÅn Admin
        const role = localStorage.getItem('user_role');
        if(role !== 'admin') {
            alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!");
            window.location.href = "index.html";
        }

        // Init
        loadStats();
        loadRequests();
        loadPendingVehicles();
        loadResidents();

        // 1. T·∫£i Th·ªëng k√™
        async function loadStats() {
            const res = await fetch('http://localhost:3000/api/admin/stats');
            const data = await res.json();
            document.getElementById('statTotal').innerText = data.total_apts;
            document.getElementById('statEmpty').innerText = data.empty_apts;
            document.getElementById('statReq').innerText = data.pending_requests;
            document.getElementById('statVeh').innerText = data.pending_vehicles;
        }

        // 2. T·∫£i Danh s√°ch Y√™u c·∫ßu
        async function loadRequests() {
            try {
                const res = await fetch('http://localhost:3000/api/admin/requests');
                const data = await res.json();
                const tbody = document.getElementById('requestTable');
                const showHistory = document.getElementById('toggleHistory').checked; // Xem c√≥ ƒëang b·∫≠t l·ªãch s·ª≠ kh√¥ng

                tbody.innerHTML = "";

                // L·ªçc d·ªØ li·ªáu
                const filteredData = data.filter(req => {
                    // N·∫øu b·∫≠t L·ªãch s·ª≠: Hi·ªán t·∫•t c·∫£
                    if (showHistory) return true;
                    // N·∫øu t·∫Øt L·ªãch s·ª≠: Ch·ªâ hi·ªán M·ªõi (New) ho·∫∑c ƒêang x·ª≠ l√Ω (Processing)
                    return req.status === 'New' || req.status === 'Processing';
                });

                if (filteredData.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">Kh√¥ng c√≥ y√™u c·∫ßu n√†o c·∫ßn x·ª≠ l√Ω.</td></tr>`;
                    return;
                }

                filteredData.forEach(req => {
                    let badge = '';
                    let actions = '';

                    // Logic hi·ªÉn th·ªã tr·∫°ng th√°i
                    if(req.status === 'New') {
                        badge = '<span class="badge bg-danger">M·ªõi</span>';
                        actions = `
                            <button class="btn btn-sm btn-primary" onclick="updateRequest(${req.request_id}, 'Processing', ${req.item_id})">üõ† X·ª≠ l√Ω</button>
                            <button class="btn btn-sm btn-success" onclick="updateRequest(${req.request_id}, 'Done', ${req.item_id})">‚úÖ Xong</button>
                        `;
                    } else if (req.status === 'Processing') {
                        badge = '<span class="badge bg-warning text-dark">ƒêang s·ª≠a</span>';
                        actions = `
                            <button class="btn btn-sm btn-success" onclick="updateRequest(${req.request_id}, 'Done', ${req.item_id})">‚úÖ Ho√†n t·∫•t</button>
                        `;
                    } else if (req.status === 'Done') {
                        badge = '<span class="badge bg-success">Ho√†n th√†nh</span>';
                    } else {
                        badge = '<span class="badge bg-secondary">ƒê√£ h·ªßy</span>';
                    }

                    // [QUAN TR·ªåNG] Th√™m s·ª± ki·ªán onclick="flyToApartment(...)" v√†o badge cƒÉn h·ªô
                    // Th√™m style cursor:pointer ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt l√† b·∫•m ƒë∆∞·ª£c
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <span class="badge bg-primary" 
                                      style="cursor: pointer; border: 1px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" 
                                      onclick="window.flyToApartment('${req.apt_code}')" 
                                      title="Click ƒë·ªÉ xem v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì">
                                    üìç ${req.apt_code}
                                </span>
                            </td>
                            <td>${req.content}</td>
                            <td>${badge}</td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });
            } catch(e) { console.error(e); }
        }

        // 3. T·∫£i Xe ch·ªù duy·ªát
        async function loadPendingVehicles() {
            const res = await fetch('http://localhost:3000/api/admin/vehicles-pending');
            const data = await res.json();
            const ul = document.getElementById('vehicleList');
            ul.innerHTML = "";

            if(data.length === 0) {
                ul.innerHTML = "<li class='list-group-item text-center text-muted'>Kh√¥ng c√≥ h·ªì s∆° ch·ªù duy·ªát</li>";
                return;
            }

            data.forEach(v => {
                let typeText = v.status === 'Pending' ? 'Xin ƒêƒÉng K√Ω' : 'Xin H·ªßy';
                let typeClass = v.status === 'Pending' ? 'text-primary' : 'text-danger';
                
                ul.innerHTML += `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <strong>${v.license_plate}</strong>
                            <span class="${typeClass} small fw-bold">${typeText}</span>
                        </div>
                        <div class="small text-muted mb-2">CƒÉn h·ªô: ${v.apt_code} | Lo·∫°i: ${v.type}</div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success flex-grow-1" onclick="approveVehicle(${v.vehicle_id}, 'Approve')">Ch·∫•p thu·∫≠n</button>
                            <button class="btn btn-sm btn-outline-danger flex-grow-1" onclick="approveVehicle(${v.vehicle_id}, 'Reject')">T·ª´ ch·ªëi</button>
                        </div>
                    </li>
                `;
            });
        }
        // T·∫£i danh s√°ch kh√°ch
        async function loadConsultations() {
            try {
                const res = await fetch('http://localhost:3000/api/admin/consultations');
                const data = await res.json();
                const tbody = document.getElementById('consultTable');
                tbody.innerHTML = "";

                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ kh√°ch ƒëƒÉng k√Ω.</td></tr>`;
                    return;
                }

                data.forEach(c => {
                    // Ch·ªâ hi·ªán kh√°ch m·ªõi (ch∆∞a k√Ω Hƒê)
                    if(c.status === 'New') {
                        tbody.innerHTML += `
                            <tr>
                                <td class="small text-muted">${new Date(c.created_at).toLocaleString('vi-VN')}</td>
                                <td class="fw-bold">${c.customer_name}</td>
                                <td>${c.phone}<br><small>${c.email}</small></td>
                                <td>
                                    <span class="badge bg-warning text-dark pointer-zoom" onclick="window.flyToApartment('${c.apt_code}')" style="cursor:pointer">
                                        ${c.apt_code}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary" 
                                        onclick="openContractModal(${c.consul_id}, ${c.apt_id}, '${c.apt_code}', '${c.customer_name}', '${c.phone}', '${c.email}')">
                                        ‚úçÔ∏è Ch·ªët ƒë∆°n
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                });
            } catch(e) { console.error(e); }
        }
        // 1. T·∫£i danh s√°ch c∆∞ d√¢n
        async function loadResidents() {
            try {
                const res = await fetch('http://localhost:3000/api/admin/residents');
                const data = await res.json();
                const tbody = document.getElementById('residentTable');
                tbody.innerHTML = "";

                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Chung c∆∞ ƒëang tr·ªëng, ch∆∞a c√≥ ai ·ªü.</td></tr>`;
                    return;
                }

                data.forEach(r => {
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <span class="badge bg-success pointer-zoom" onclick="window.flyToApartment('${r.apt_code}')">
                                    ${r.apt_code}
                                </span>
                            </td>
                            <td class="fw-bold">${r.full_name}</td>
                            <td>${r.phone}<br><small class="text-muted">${r.email}</small></td>
                            <td>${new Date(r.start_date).toLocaleDateString('vi-VN')}</td>
                            <td><code>${r.username || 'Ch∆∞a c√≥'}</code></td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" 
                                    onclick="processMoveOut(${r.res_id}, '${r.apt_code}', '${r.full_name}')">
                                    üö™ Tr·∫£ ph√≤ng
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="resetPass(${r.res_id}, '${r.full_name}')">
                                    üîë Reset Pass
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) { console.error(e); }
        }

        // 2. X·ª≠ l√Ω Tr·∫£ ph√≤ng
        async function processMoveOut(resId, aptCode, name) {
            const confirmMsg = `‚ö†Ô∏è C·∫¢NH B√ÅO QUAN TR·ªåNG:\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l√†m th·ªß t·ª•c TR·∫¢ PH√íNG cho c∆∞ d√¢n [${name}] t·∫°i cƒÉn [${aptCode}]?\n\n- H·ª£p ƒë·ªìng s·∫Ω k·∫øt th√∫c.\n- T√†i kho·∫£n App s·∫Ω b·ªã kh√≥a.\n- CƒÉn h·ªô s·∫Ω chuy·ªÉn v·ªÅ tr·∫°ng th√°i TR·ªêNG (M√†u x√°m).`;
            
            if(!confirm(confirmMsg)) return;

            try {
                const res = await fetch('http://localhost:3000/api/admin/move-out', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ res_id: resId, apt_code: aptCode })
                });
                const data = await res.json();

                if(data.success) {
                    alert(data.message);
                    
                    // Reload l·∫°i to√†n b·ªô h·ªá th·ªëng
                    loadResidents();     // C·∫≠p nh·∫≠t b·∫£ng c∆∞ d√¢n
                    loadStats();         // C·∫≠p nh·∫≠t s·ªë li·ªáu cƒÉn tr·ªëng
                    if(window.refresh3DMap) window.refresh3DMap(); // Map chuy·ªÉn t·ª´ Xanh -> X√°m ngay l·∫≠p t·ª©c
                } else {
                    alert("L·ªói: " + data.message);
                }
            } catch(e) { alert("L·ªói k·∫øt n·ªëi server"); }
        }

        // M·ªü Modal Ch·ªët ƒë∆°n
        window.openContractModal = function(consulId, aptId, aptCode, name, phone, email) {
            document.getElementById('con_consul_id').value = consulId;
            document.getElementById('con_apt_id').value = aptId;
            document.getElementById('con_apt_code').innerText = aptCode;
            document.getElementById('con_name').value = name;
            
            // G·ª£i √Ω username: user_sƒët
            document.getElementById('con_username').value = "user_" + phone;
            
            new bootstrap.Modal(document.getElementById('contractModal')).show();
        };

        // G·ª≠i l·ªánh T·∫°o H·ª£p ƒê·ªìng
        async function submitContract() {
            if(!confirm("X√°c nh·∫≠n k√Ω h·ª£p ƒë·ªìng?")) return;

            const payload = {
                consul_id: document.getElementById('con_consul_id').value,
                apt_id: document.getElementById('con_apt_id').value,
                full_name: document.getElementById('con_name').value,
                // L·∫•y SƒêT t·ª´ username (c·∫Øt b·ªè user_) ho·∫∑c l·∫•y t·ª´ data ·∫©n n·∫øu c·∫ßn k·ªπ h∆°n
                phone: document.getElementById('con_username').value.replace('user_', ''), 
                email: "", 
                username: document.getElementById('con_username').value,
                password: document.getElementById('con_password').value
            };

            try {
                const res = await fetch('http://localhost:3000/api/admin/create-contract', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if(data.success) {
                    alert(data.message);
                    if (document.activeElement) document.activeElement.blur();
                    bootstrap.Modal.getInstance(document.getElementById('contractModal')).hide();
                    
                    // Reload l·∫°i d·ªØ li·ªáu
                    loadConsultations(); 
                    loadStats();         
                    if(window.refresh3DMap) window.refresh3DMap(); // C·∫≠p nh·∫≠t m√†u xanh cho Map
                } else {
                    alert("L·ªói: " + data.message);
                }
            } catch(e) { alert("L·ªói Server"); }
        }
        //X·ª≠ l√Ω Reset Password
        async function resetPass(resId, name) {
        if(!confirm(`B·∫°n mu·ªën ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u cho c∆∞ d√¢n [${name}] v·ªÅ m·∫∑c ƒë·ªãnh l√† 123456?`)) return;
}
        // --- T√çNH NƒÇNG T√åM KI·∫æM C∆Ø D√ÇN (LIVE SEARCH) ---
        function searchResident() {
            // 1. L·∫•y t·ª´ kh√≥a ng∆∞·ªùi d√πng nh·∫≠p v√†o (chuy·ªÉn v·ªÅ ch·ªØ th∆∞·ªùng)
            let input = document.getElementById('searchResInput');
            let filter = input.value.toLowerCase();
            
            // 2. L·∫•y b·∫£ng v√† c√°c d√≤ng d·ªØ li·ªáu
            let table = document.getElementById('residentTable');
            let tr = table.getElementsByTagName('tr');

            // 3. Duy·ªát qua t·ª´ng d√≤ng ƒë·ªÉ ki·ªÉm tra
            for (let i = 0; i < tr.length; i++) {
                // B·ªè qua d√≤ng th√¥ng b√°o "ƒêang t·∫£i..." n·∫øu c√≥
                if(tr[i].getElementsByTagName('td').length < 2) continue;

                // L·∫•y n·ªôi dung c√°c c·ªôt quan tr·ªçng: CƒÉn h·ªô (0), T√™n (1), SƒêT (2)
                let tdApt = tr[i].getElementsByTagName('td')[0];
                let tdName = tr[i].getElementsByTagName('td')[1];
                let tdPhone = tr[i].getElementsByTagName('td')[2];

                if (tdApt && tdName && tdPhone) {
                    let txtApt = tdApt.textContent || tdApt.innerText;
                    let txtName = tdName.textContent || tdName.innerText;
                    let txtPhone = tdPhone.textContent || tdPhone.innerText;

                    // Ki·ªÉm tra xem t·ª´ kh√≥a c√≥ n·∫±m trong T√™n HO·∫∂C SƒêT HO·∫∂C M√£ cƒÉn kh√¥ng
                    if (txtApt.toLowerCase().indexOf(filter) > -1 || 
                        txtName.toLowerCase().indexOf(filter) > -1 || 
                        txtPhone.toLowerCase().indexOf(filter) > -1) {
                        
                        tr[i].style.display = ""; // C√≥ ch·ª©a t·ª´ kh√≥a -> Hi·ªán
                    } else {
                        tr[i].style.display = "none"; // Kh√¥ng ch·ª©a -> ·∫®n
                    }
                }
            }
        }
        // --- C√ÅC H√ÄM H√ÄNH ƒê·ªòNG ---

        // X·ª≠ l√Ω Y√™u c·∫ßu
        async function updateRequest(reqId, status, itemId) {
            if(!confirm("X√°c nh·∫≠n c·∫≠p nh·∫≠t tr·∫°ng th√°i?")) return;
            try {
                const res = await fetch('http://localhost:3000/api/admin/update-request-status', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ request_id: reqId, status: status, item_id: itemId })
                });
                
                // 1. T·∫£i l·∫°i b·∫£ng danh s√°ch
                loadRequests(); 
                
                // 2. T·∫£i l·∫°i th·ªëng k√™
                loadStats();    

                // 3. [M·ªöI] T·∫£i l·∫°i m√†u s·∫Øc B·∫£n ƒë·ªì ngay l·∫≠p t·ª©c
                if (window.refresh3DMap) {
                    window.refresh3DMap(); 
                }

            } catch(e) { alert("L·ªói k·∫øt n·ªëi"); }
        }

        function logout() {
            localStorage.clear();
            window.location.href = "index.html";
        }
    </script>
<script type="module" src="./src/admin_map.js"></script>
</body>
</html>