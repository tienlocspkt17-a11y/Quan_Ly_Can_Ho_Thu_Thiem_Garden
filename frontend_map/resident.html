<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C·ªïng C∆∞ D√¢n Online</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <style>
        body { background: #f0f2f5; padding-bottom: 50px; }
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 12px; margin-bottom: 20px; }
        .card-header { background: #fff; border-bottom: 1px solid #eee; font-weight: bold; color: #005555; }
        .cursor-pointer { cursor: pointer; color: #0d6efd; text-decoration: underline; }
        .cursor-pointer:hover { color: #0a58ca; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary px-4 mb-4">
        <span class="navbar-brand mb-0 h1">üè° C·ªïng C∆∞ D√¢n - Th·ªß Thi√™m Garden</span>
        <div>
            <button class="btn btn-outline-light btn-sm me-2" onclick="openChangePassModal()">üîë ƒê·ªïi m·∫≠t kh·∫©u</button>
            <button class="btn btn-light btn-sm" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
    </nav>

    <div class="modal fade" id="changePassModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">ƒê·ªïi m·∫≠t kh·∫©u</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePassForm">
                        <div class="mb-2">
                            <label>M·∫≠t kh·∫©u c≈©</label>
                            <input type="password" class="form-control" id="oldPass" required>
                        </div>
                        <div class="mb-3">
                            <label>M·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" class="form-control" id="newPass" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">X√°c nh·∫≠n</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card p-4 bg-white">
                    <h4>Xin ch√†o, <span id="userName" class="text-primary">...</span> üëã</h4>
                    <p class="mb-0">CƒÉn h·ªô c·ªßa b·∫°n: <strong id="userCode" class="badge bg-warning text-dark fs-6">...</strong></p>
                </div>
            </div>
        </div>

<div class="row">
    <div class="col-lg-6 mb-4">
        
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white text-primary fw-bold border-bottom">üßæ H√≥a ƒê∆°n C·ªßa T√¥i</div>
            <div class="card-body">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Th√°ng</th>
                            <th>S·ªë ti·ªÅn (VNƒê)</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceList">
                        <tr><td colspan="3">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white text-dark fw-bold border-bottom">üõãÔ∏è N·ªôi th·∫•t & T√†i s·∫£n B√†n giao</div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="furnitureList">
                     <li class="list-group-item text-center text-muted py-3">ƒêang t·∫£i...</li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom">
                <span class="fw-bold text-dark">üöó Ph∆∞∆°ng Ti·ªán ƒêƒÉng K√Ω</span>
                <button class="btn btn-sm btn-success" onclick="openRegVehicleModal()">+ ƒêƒÉng k√Ω xe</button>
            </div>
            <ul class="list-group list-group-flush" id="vehicleList">
                <li class="list-group-item text-center text-muted py-3">ƒêang t·∫£i...</li>
            </ul>
            <div class="card-footer bg-light text-muted small fst-italic">
                *Quy ƒë·ªãnh: T·ªëi ƒëa 1 √î t√¥ & 3 Xe m√°y / CƒÉn h·ªô
            </div>
        </div>

    </div>

    <div class="col-lg-6 mb-4">

        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white text-danger fw-bold border-bottom">üîß B√°o S·ª± C·ªë / Y√™u C·∫ßu</div>
            <div class="card-body">
                <form id="requestForm">
                    <div class="mb-3">
                        <textarea class="form-control" id="reqContent" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt v·∫•n ƒë·ªÅ c·ªßa b·∫°n (VD: V√≤i n∆∞·ªõc b·ªã r·ªâ...)" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2">G·ª≠i Y√™u C·∫ßu H·ªó Tr·ª£</button>
                </form>
            </div>
        </div>

        <div class="card shadow-sm border-0" style="min-height: 300px;">
            <div class="card-header bg-white text-dark fw-bold border-bottom">üïí L·ªãch s·ª≠ y√™u c·∫ßu</div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="requestHistoryList">
                    <li class="list-group-item text-center text-muted py-3">Ch∆∞a c√≥ y√™u c·∫ßu n√†o</li>
                </ul>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="regVehicleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ƒêƒÉng k√Ω g·ª≠i xe m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="regVehicleForm">
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i xe</label>
                        <select class="form-select" id="vehType">
                            <option value="Motorbike">Xe m√°y (Motorbike)</option>
                            <option value="Car">√î t√¥ (Car)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bi·ªÉn s·ªë xe</label>
                        <input type="text" class="form-control" id="vehPlate" placeholder="VD: 59-X1 999.99" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">X√°c nh·∫≠n ƒêƒÉng k√Ω</button>
                </form>
            </div>
        </div>
    </div>
</div>
        <div class="text-center mt-3">
            <a href="index.html" class="text-decoration-none text-secondary">‚Üê Quay l·∫°i B·∫£n ƒë·ªì 3D</a>
        </div>
    </div>

    <div class="modal fade" id="invoiceDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Chi ti·∫øt s·ª≠ d·ª•ng d·ªãch v·ª•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <thead><tr><th>D·ªãch v·ª•</th><th>S·ª≠ d·ª•ng</th><th>Th√†nh ti·ªÅn</th></tr></thead>
                        <tbody id="invoiceDetailBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script> <script>
        // 1. Kh·ªüi t·∫°o
        const name = localStorage.getItem('user_name');
        const code = localStorage.getItem('user_code');
        const resId = localStorage.getItem('user_res_id');

        if(!name) {
            window.location.href = "index.html";
        } else {
            document.getElementById("userName").innerText = name;
            document.getElementById("userCode").innerText = code || "Ch∆∞a c·∫≠p nh·∫≠t";
            
            // G·ªçi c√°c h√†m t·∫£i d·ªØ li·ªáu
            if(resId) {
                loadInvoices(resId);
                loadVehicles(resId);
                loadRequestHistory(resId);
                loadFurniture(resId);
            }
        }

        // 2. T·∫£i h√≥a ƒë∆°n (ƒê√£ s·ª≠a l·ªói n√∫t Xem)
        async function loadInvoices(id) {
            try {
                const res = await fetch(`http://localhost:3000/api/resident/invoices/${id}`);
                const data = await res.json();
                const tbody = document.getElementById("invoiceList");
                tbody.innerHTML = "";

                if(data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='3'>Kh√¥ng c√≥ h√≥a ƒë∆°n.</td></tr>";
                    return;
                }

                data.forEach(inv => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${inv.month}</td>
                        <td class="fw-bold">
                            ${parseInt(inv.total_amount).toLocaleString('vi-VN')} 
                            <span class="cursor-pointer small ms-1" onclick="showInvoiceDetail(${inv.invoice_id})">(Xem)</span>
                        </td>
                        <td>
                            ${inv.is_paid 
                                ? '<span class="badge bg-success">ƒê√£ tr·∫£</span>' 
                                : '<span class="badge bg-danger">Ch∆∞a tr·∫£</span>'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(err) { console.error(err); }
        }

        // 3. Xem chi ti·∫øt h√≥a ƒë∆°n (Popup)
        window.showInvoiceDetail = async function(invId) {
            try {
                const res = await fetch(`http://localhost:3000/api/resident/invoice-details/${invId}`);
                const data = await res.json();
                const tbody = document.getElementById("invoiceDetailBody");
                tbody.innerHTML = "";
                
                if(data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='3'>Ch∆∞a c√≥ chi ti·∫øt.</td></tr>";
                } else {
                    data.forEach(d => {
                        tbody.innerHTML += `<tr>
                            <td>${d.name}</td>
                            <td>${d.usage_amount}</td>
                            <td>${parseInt(d.sub_total).toLocaleString()}</td>
                        </tr>`;
                    });
                }
                
                // Hi·ªÉn th·ªã Modal (Bootstrap 5)
                var myModal = new bootstrap.Modal(document.getElementById('invoiceDetailModal'));
                myModal.show();
            } catch(e) { alert("L·ªói t·∫£i chi ti·∫øt!"); }
        }

        // 4. T·∫£i Xe c·ªô
async function loadVehicles(id) {
    try {
        const res = await fetch(`http://localhost:3000/api/resident/vehicles/${id}`);
        const data = await res.json();
        const ul = document.getElementById("vehicleList");
        ul.innerHTML = "";
        
        if(data.length === 0) {
            ul.innerHTML = "<li class='list-group-item text-muted text-center'>Ch∆∞a ƒëƒÉng k√Ω xe</li>";
            return;
        }
        
        data.forEach(v => {
            let icon = v.type === 'Car' ? 'üöô' : 'üõµ';
            let badgeClass = 'bg-secondary';
            let statusText = 'Kh√¥ng r√µ';
            let actionBtn = '';
            let locationInfo = '';

            if (v.status === 'Active') {
                badgeClass = 'bg-success';
                statusText = 'ƒêang s·ª≠ d·ª•ng';
                // N√∫t y√™u c·∫ßu h·ªßy
                actionBtn = `<button class="btn btn-sm btn-outline-danger mt-1" onclick="cancelVehicle(${v.vehicle_id})">Y√™u c·∫ßu h·ªßy</button>`;
                
                if(v.type === 'Car' && v.slot_code) {
                    locationInfo = `<div class="small text-success mt-1"><i class="bi bi-geo-alt-fill"></i> V·ªã tr√≠: <strong>${v.slot_code}</strong> (${v.zone_name})</div>`;
                } else if (v.type === 'Car' && !v.slot_code) {
                    locationInfo = `<div class="small text-muted mt-1 fst-italic">Ch∆∞a x·∫øp ch·ªó</div>`;
                }

            } else if (v.status === 'Pending') {
                badgeClass = 'bg-warning text-dark';
                statusText = 'Ch·ªù duy·ªát';
                // N√∫t h·ªßy ƒëƒÉng k√Ω ngay
                actionBtn = `<button class="btn btn-sm btn-outline-secondary mt-1" onclick="cancelVehicle(${v.vehicle_id})">H·ªßy ƒëƒÉng k√Ω</button>`;

            } else if (v.status === 'Pending_Cancellation') {
                badgeClass = 'bg-info text-dark';
                statusText = 'Ch·ªù x√°c nh·∫≠n h·ªßy';
                // [LOGIC M·ªöI] N√∫t Kh√¥i ph·ª•c (Kh√¥ng h·ªßy n·ªØa)
                actionBtn = `<button class="btn btn-sm btn-primary mt-1" onclick="undoCancelVehicle(${v.vehicle_id})">‚Ü©Ô∏è Gi·ªØ l·∫°i xe n√†y</button>`;

            } else if (v.status === 'Cancelled') {
                badgeClass = 'bg-secondary';
                statusText = 'ƒê√£ h·ªßy';
            }

            ul.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                        <span>${icon} ${v.type}</span> <strong class="text-primary ms-1">${v.license_plate}</strong>
                        ${locationInfo}
                        <div class="mt-1">${actionBtn}</div>
                    </div>
                    <span class="badge ${badgeClass} rounded-pill mt-1">${statusText}</span>
                </li>`;
        });
    } catch(e) { console.error(e); }
}
        // 5. G·ª≠i y√™u c·∫ßu
        document.getElementById("requestForm").addEventListener("submit", async function(e){
            e.preventDefault();
            const content = document.getElementById("reqContent").value;

            try {
                const res = await fetch('http://localhost:3000/api/resident/requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ res_id: resId, apt_code: code, content: content })
                });
                const result = await res.json();
                
                if(result.success) {
                    alert("‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu!");
                    document.getElementById("reqContent").value = "";
                    loadRequestHistory(resId); // T·∫£i l·∫°i danh s√°ch ngay l·∫≠p t·ª©c
                } else {
                    alert("‚ùå L·ªói: " + result.message);
                }
            } catch(err) { alert("L·ªói k·∫øt n·ªëi!"); }
        });

        // 6. T·∫£i L·ªãch s·ª≠ y√™u c·∫ßu
 async function loadRequestHistory(id) {
    try {
        const res = await fetch(`http://localhost:3000/api/resident/requests-history/${id}`);
        const data = await res.json();
        const ul = document.getElementById("requestHistoryList");
        ul.innerHTML = "";

        if(data.length === 0) {
            ul.innerHTML = "<li class='list-group-item text-muted text-center'>Ch∆∞a c√≥ y√™u c·∫ßu n√†o</li>";
            return;
        }

        data.forEach(req => {
            let badge = '';
            let btnCancel = '';

            if (req.status === 'New') {
                badge = 'bg-primary';
                // Ch·ªâ hi·ªán n√∫t h·ªßy n·∫øu tr·∫°ng th√°i l√† New
                btnCancel = `<button class="btn btn-sm btn-link text-danger text-decoration-none p-0 ms-2" onclick="cancelRequest(${req.request_id})">(H·ªßy)</button>`;
            } else if (req.status === 'Done') {
                badge = 'bg-success';
            } else if (req.status === 'Cancelled') {
                badge = 'bg-secondary';
            }

            ul.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${req.content} ${btnCancel}</span>
                    <span class="badge ${badge} rounded-pill">${req.status}</span>
                </li>
            `;
        });
    } catch(e) {}
}
// 7. T·∫£i danh s√°ch n·ªôi th·∫•t
async function loadFurniture(id) {
    try {
        // M·∫∏O: Th√™m ?t=${new Date().getTime()} ƒë·ªÉ tr√¨nh duy·ªát lu√¥n t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t
        const res = await fetch(`http://localhost:3000/api/resident/furniture/${id}?t=${new Date().getTime()}`);
        const data = await res.json();
        const ul = document.getElementById("furnitureList");
        ul.innerHTML = "";

        if(data.length === 0) {
            ul.innerHTML = "<li class='list-group-item text-center'>Kh√¥ng c√≥ t√†i s·∫£n b√†n giao</li>";
            return;
        }

        data.forEach(item => {
            let badgeClass = '';
            let btnAction = '';
            let safeName = item.name.replace(/'/g, "\\'"); // X·ª≠ l√Ω t√™n c√≥ d·∫•u nh√°y ƒë∆°n

            if(item.condition === 'ƒêang ho·∫°t ƒë·ªông') {
                badgeClass = 'bg-success'; 
                // Hi·ªán n√∫t b√°o h·ªèng
                btnAction = `<button class="btn btn-sm btn-outline-danger ms-2" onclick="reportFurniture(${item.item_id}, '${safeName}')">‚ö†Ô∏è B√°o h·ªèng</button>`;
            } else {
                badgeClass = 'bg-warning text-dark'; 
                // ·∫®n n√∫t b√°o h·ªèng
                btnAction = `<small class="text-muted ms-2 fst-italic">(ƒê√£ g·ª≠i y√™u c·∫ßu)</small>`;
            }

            ul.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">${item.name}</span>
                        ${btnAction}
                    </div>
                    <span class="badge ${badgeClass} rounded-pill">${item.condition}</span>
                </li>
            `;
        });
    } catch(e) { console.error(e); }
}

// H√†m x·ª≠ l√Ω Kh√¥i ph·ª•c xe (Undo Cancel)
async function undoCancelVehicle(vehId) {
    try {
        const res = await fetch('http://localhost:3000/api/resident/undo-cancel-vehicle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vehicle_id: vehId })
        });
        const result = await res.json();
        alert(result.message);
        loadVehicles(localStorage.getItem('user_res_id')); // Load l·∫°i danh s√°ch
    } catch(e) { alert("L·ªói k·∫øt n·ªëi!"); }
}

// H√†m H·ªßy Y√™u c·∫ßu (Th√™m reload n·ªôi th·∫•t)
async function cancelRequest(reqId) {
    if(!confirm("H·ªßy y√™u c·∫ßu n√†y?")) return;

    try {
        const res = await fetch('http://localhost:3000/api/resident/cancel-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ request_id: reqId })
        });
        const result = await res.json();
        
        // [QUAN TR·ªåNG] Load l·∫°i c·∫£ l·ªãch s·ª≠ V√Ä danh s√°ch n·ªôi th·∫•t
        // ƒê·ªÉ n√∫t "B√°o h·ªèng" hi·ªán l·∫°i ngay l·∫≠p t·ª©c
        const resId = localStorage.getItem('user_res_id');
        loadRequestHistory(resId); 
        loadFurniture(resId); 

    } catch(e) { alert("L·ªói k·∫øt n·ªëi!"); }
}

// 8. H√†m x·ª≠ l√Ω B√°o h·ªèng
async function reportFurniture(itemId, itemName) {
    console.log("ƒêang b√°o h·ªèng:", itemId, itemName); // Check log xem t√™n ƒë√∫ng ko

    const desc = prompt(`M√¥ t·∫£ t√¨nh tr·∫°ng h∆∞ h·ªèng c·ªßa "${itemName}":`, "Kh√¥ng ho·∫°t ƒë·ªông");
    if(!desc) return; 

    const resId = localStorage.getItem('user_res_id');
    if(!resId) { alert("L·ªói: Kh√¥ng t√¨m th·∫•y ID c∆∞ d√¢n. H√£y ƒëƒÉng nh·∫≠p l·∫°i."); return; }

    try {
        const res = await fetch('http://localhost:3000/api/resident/report-furniture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                res_id: resId, 
                item_id: itemId,
                item_name: itemName,
                description: desc
            })
        });
        const result = await res.json();
        
        if(result.success) {
            alert("‚úÖ ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng!");
            // Load l·∫°i c·∫£ 2 danh s√°ch ƒë·ªÉ ƒë·ªìng b·ªô
            loadFurniture(resId); 
            loadRequestHistory(resId); 
        } else {
            alert("‚ùå L·ªói t·ª´ Server: " + (result.message || "Kh√¥ng r√µ nguy√™n nh√¢n"));
        }
    } catch(e) { 
        console.error(e);
        alert("‚ùå L·ªói k·∫øt n·ªëi (Xem Console ƒë·ªÉ bi·∫øt chi ti·∫øt)!"); 
    }
}

// --- C√ÅC H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN H·ª¶Y ---

// H√†m H·ªßy Xe
async function cancelVehicle(vehId) {
    if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒëƒÉng k√Ω xe n√†y kh√¥ng?")) return;
    
    try {
        const res = await fetch('http://localhost:3000/api/resident/cancel-vehicle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vehicle_id: vehId })
        });
        const result = await res.json();
        alert(result.message);
        loadVehicles(localStorage.getItem('user_res_id')); // T·∫£i l·∫°i danh s√°ch
    } catch(e) { alert("L·ªói k·∫øt n·ªëi!"); }
}

// H√†m H·ªßy Y√™u c·∫ßu
async function cancelRequest(reqId) {
    if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy y√™u c·∫ßu n√†y kh√¥ng?")) return;

    try {
        const res = await fetch('http://localhost:3000/api/resident/cancel-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ request_id: reqId })
        });
        const result = await res.json();
        
        if(result.success) {
            // Kh√¥ng c·∫ßn alert c≈©ng ƒë∆∞·ª£c cho thao t√°c nhanh, ho·∫∑c d√πng Toast
            // alert("ƒê√£ h·ªßy y√™u c·∫ßu."); 
            
            const resId = localStorage.getItem('user_res_id');
            
            // [QUAN TR·ªåNG] G·ªçi l·∫°i c·∫£ 2 h√†m ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
            await loadRequestHistory(resId); // C·∫≠p nh·∫≠t list l·ªãch s·ª≠ (chuy·ªÉn th√†nh Cancelled)
            await loadFurniture(resId);      // C·∫≠p nh·∫≠t list ƒë·ªì ƒë·∫°c (chuy·ªÉn th√†nh ƒêang ho·∫°t ƒë·ªông)
            
        } else {
            alert("L·ªói: " + result.message);
        }
    } catch(e) { 
        console.error(e);
        alert("L·ªói k·∫øt n·ªëi Server!"); 
    }
}
//  M·ªü Modal ƒëƒÉng k√Ω
        function openRegVehicleModal() {
            new bootstrap.Modal(document.getElementById('regVehicleModal')).show();
        }

    // X·ª≠ l√Ω s·ª± ki·ªán Submit Form ƒêƒÉng k√Ω xe
        document.getElementById("regVehicleForm").addEventListener("submit", async function(e){
            e.preventDefault();
            const type = document.getElementById("vehType").value;
            const plate = document.getElementById("vehPlate").value;

            try {
                const res = await fetch('http://localhost:3000/api/resident/register-vehicle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ res_id: resId, type: type, license_plate: plate })
                });
                const result = await res.json();
            
                if(result.success) {
                alert(result.message); // B√°o th√†nh c√¥ng
                    // T·∫Øt modal (th·ªß c√¥ng)
                    const modalEl = document.getElementById('regVehicleModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    modalInstance.hide();

                    // T·∫£i l·∫°i danh s√°ch xe
                    loadVehicles(resId);
                } else {
                    alert(result.message); // B√°o l·ªói (VD: Qu√° s·ªë l∆∞·ª£ng)
                }
            } catch(err) { alert("L·ªói k·∫øt n·ªëi Server!"); }
        });

        // 9. ƒêƒÉng xu·∫•t
        function logout() {
            localStorage.clear();
            window.location.href = "index.html";
        }
        // 10. H√†m m·ªü Modal ƒê·ªïi m·∫≠t kh·∫©u
        function openChangePassModal() {
            new bootstrap.Modal(document.getElementById('changePassModal')).show();
        }

        // 11. X·ª≠ l√Ω s·ª± ki·ªán khi b·∫•m n√∫t "X√°c nh·∫≠n" ƒë·ªïi m·∫≠t kh·∫©u
        document.getElementById("changePassForm").addEventListener("submit", async function(e){
            e.preventDefault();
            
            const oldPass = document.getElementById("oldPass").value;
            const newPass = document.getElementById("newPass").value;
            
            // L·∫•y username t·ª´ localStorage (C·∫ßn ƒë·∫£m b·∫£o file index.html ƒë√£ l∆∞u c√°i n√†y)
            // N·∫øu ch∆∞a l∆∞u th√¨ m·∫∑c ƒë·ªãnh th·ª≠ l·∫•y 'cudana' ƒë·ªÉ test
            const u = localStorage.getItem('user_username') || 'cudana'; 

            try {
                const res = await fetch('http://localhost:3000/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, oldPass: oldPass, newPass: newPass })
                });
                const result = await res.json();
                
                alert(result.message);
                
                if(result.success) {
                    // T·∫Øt modal sau khi th√†nh c√¥ng
                    const modalEl = document.getElementById('changePassModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    modalInstance.hide();
                    
                    // Reset form
                    document.getElementById("changePassForm").reset();
                }
            } catch(err) { 
                console.error(err);
                alert("L·ªói k·∫øt n·ªëi Server!"); 
            }
        });
    </script>
</body>
</html>